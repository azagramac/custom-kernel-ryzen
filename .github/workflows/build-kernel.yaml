name: 🐧 Build Linux Kernel Ryzen9 - 5950X

on:
  schedule:
    - cron: '0 4 * * 1'
  workflow_dispatch:

env:
  KERNEL_BASE_URL: https://www.kernel.org/pub/linux/kernel/v6.x
  LOCALVERSION: "-ryzen9"

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    env:
      DEBFULLNAME: ${{ secrets.DEBFULLNAME }}
      DEBEMAIL: ${{ secrets.DEBEMAIL }}

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🌐 Get latest stable 6.x kernel version
        id: kernel-version
        run: |
          echo "Fetching latest stable 6.x kernel version..."
          KERNEL=$(curl -s https://www.kernel.org/releases.json | jq -r '.latest_stable.version')
          echo "Latest kernel: $KERNEL"
          echo "KERNEL_VERSION=$KERNEL" >> $GITHUB_OUTPUT

      - name: 📂 Prepare build directory
        run: |
          mkdir -p kernel_build
          cd kernel_build
          echo "Build directory ready"

      - name: 📥 Download kernel source
        run: |
          cd kernel_build
          KERNEL_TAR="linux-${{ steps.kernel-version.outputs.KERNEL_VERSION }}.tar.xz"
          curl -LO ${{ env.KERNEL_BASE_URL }}/$KERNEL_TAR
          tar -xf $KERNEL_TAR --strip-components=1
          echo "Kernel source extracted"

      - name: ⚙️ Copy current config
        run: |
          cp $GITHUB_WORKSPACE/.config kernel_build/.config

      - name: 🖌️ Update config for ryzen9
        run: |
          cd kernel_build
          scripts/config --set-str LOCALVERSION ${{ env.LOCALVERSION }}
          make olddefconfig

      - name: 🏗️ Build Debian packages
        run: |
          cd kernel_build
          make -j$(nproc) deb-pkg LOCALVERSION=${{ env.LOCALVERSION }}
          echo "Kernel packages built"

      - name: 📦 Upload .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-debs
          path: |
            kernel_build/*.deb
            
